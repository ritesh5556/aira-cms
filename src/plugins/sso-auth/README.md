# SSO Magic Link Authentication Plugin

This plugin implements SSO (Single Sign-On) authentication for the Strapi admin panel using magic links.

## How It Works

1. **Your application generates a JWT token** containing user information (email, name, etc.)
2. **User clicks magic link** with format: `http://your-strapi-url/api/sso-login?token=YOUR_JWT_TOKEN`
3. **Strapi verifies the JWT** using your shared secret
4. **Strapi creates/fetches admin user** based on email
5. **Strapi generates admin session** and sets authentication cookie
6. **User is redirected to `/admin`** and automatically logged in

## Setup

### 1. Environment Variables

Add to your `.env` file:

```env
SSO_JWT_SECRET=your-shared-secret-here
```

**Important**: This secret must match the secret used in your application to generate the JWT tokens.

### 2. JWT Token Structure

Your application should generate JWT tokens with the following payload:

```javascript
{
  email: "user@example.com",        // Required
  firstname: "John",                // Optional
  lastname: "Doe",                  // Optional
  name: "John Doe",                 // Optional (used if firstname/lastname not provided)
  exp: 1234567890                   // Required - token expiration timestamp
}
```

### 3. Example: Generating Tokens in Your Application

```javascript
const jwt = require('jsonwebtoken');

function generateMagicLinkToken(email, name) {
  const token = jwt.sign(
    {
      email,
      name,
      exp: Math.floor(Date.now() / 1000) + (60 * 15), // 15 minutes expiry
    },
    process.env.SSO_JWT_SECRET
  );
  
  return token;
}

// Generate magic link
const token = generateMagicLinkToken('user@example.com', 'John Doe');
const magicLink = `https://your-strapi-url.com/api/sso-login?token=${token}`;

// Send this link via email
```

## API Endpoint

### GET /api/sso-login

**Query Parameters:**
- `token` (required): JWT token generated by your application

**Response:**
- Redirects to `/admin` with authentication cookie set
- Returns 400/401 for invalid tokens
- Returns 500 for server errors

## Security Features

- ✅ JWT signature verification
- ✅ Token expiration checking
- ✅ HTTP-only cookies (prevents XSS)
- ✅ User email validation
- ✅ Admin user creation/lookup
- ✅ User activation status check

## User Roles

By default, new users are created with **Super Admin** role. To change this:

1. Open `server/controllers/sso.js`
2. Modify the role lookup (line 53):

```javascript
// Change from 'strapi-super-admin' to another role
const role = await strapi.db.query('admin::role').findOne({
  where: { code: 'strapi-editor' }, // or 'strapi-author'
});
```

## Troubleshooting

### User sees login page instead of dashboard

**Cause**: Cookie not being set properly

**Solutions**:
- Check that `NODE_ENV` is set correctly
- Verify cookie domain settings
- Ensure HTTPS in production (secure cookies)
- Check browser cookie policies

### "Invalid or expired token" error

**Causes**:
- JWT secret mismatch between your app and Strapi
- Token expired
- Malformed token

**Solutions**:
- Verify `SSO_JWT_SECRET` matches in both applications
- Check token expiration time
- Validate JWT token format

### "Super Admin role not found" error

**Cause**: Database not properly initialized

**Solution**: 
- Ensure Strapi admin has been set up at least once
- Check database for admin roles table

## Development Testing

```bash
# Generate a test token
node -e "const jwt = require('jsonwebtoken'); console.log(jwt.sign({email: 'test@example.com', name: 'Test User', exp: Math.floor(Date.now()/1000) + 900}, 'your-secret'));"

# Test the endpoint
curl "http://localhost:1337/api/sso-login?token=YOUR_TOKEN"
```

## Production Considerations

1. **Use HTTPS**: Secure cookies require HTTPS in production
2. **Short Token Expiry**: Magic link tokens should expire quickly (5-15 minutes)
3. **Rate Limiting**: Consider adding rate limiting to prevent abuse
4. **Audit Logging**: Add logging for security audits
5. **Token Single-Use**: Consider implementing one-time token usage

## License

Same as your Strapi project.
